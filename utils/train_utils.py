#loss function, training loop, sampling utilities